<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Quiz Automotivo</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="./dash.css">
    <link rel="stylesheet" href="../conta.css">
    <link rel="stylesheet" href="../extras.css">

</head>
   <header class="topbar">
        <nav class="menu-header">
            <ul class="menu-list">
                <li class="selects-animated">
                    <a href="#" class="selects-links">Inicio</a>
                    <ul class="links-usuario1">
                        <li><a href="../index.html">Home</a></li>
                        <li class="is_logged_false"><a href="../autenticacao/cadastro.html">Cadastro</a></li>
                        <li class="is_logged_false"><a href="../autenticacao/login.html">Login</a></li>
                    </ul>
                </li>
                <li class="selects-animated2">
                    <a href="#" class="selects-links">Mecânica</a>
                    <ul class="links-header">
                        <li><a href="../mecanica/motores.html">Motores</a></li>
                        <li><a href="../mecanica/injecao.html">Injeção</a></li>
                        <li><a href="../mecanica/cambio.html">Câmbio</a></li>
                    </ul>
                </li>

                <li class="selects-animated3">
                    <a href="#" class="selects-links">Sistemas de sobrealimentação</a>
                    <ul class="links-usuario2">
                        <li><a href="../sobrealimentacao/turbocompressor.html">Turbocompressores:</a></li>
                    </ul>
                </li>


                <li class="selects-animated4">
                    <a href="#" class="selects-links">Quiz</a>
                    <ul class="links-usuario3">
                        <li><a href="../quiz/dashboard.html">Dashboard</a></li>
                        <li class="is_logged"><a href="../quiz/EXEMPLO_QUIZZ.html">Quiz</a></li>
                    </ul>
                </li>

                <li class="selects-animated4 is_logged">
                    <button onclick="sair()" class="selects-links">Sair</a>
                </li>


            </ul>
        </nav>
    </header>

<body onload="carregarDashboard(); carregarGraficoHistorico();">

    <div class="conteudo">

        <div class="kpis">
            <div class="kpi">
                <h3>Media de Acertos</h3>
                <span id="kpi_acertos">0</span>
            </div>

            <div class="kpi">
                <h3>Media de Erros</h3>
                <span id="kpi_erros">0</span>
            </div>

            <div class="kpi">
                <h3>Tentativas</h3>
                <span id="kpi_tentativas">0</span>
            </div>
        </div>

        <div class="graficocontainer">
            <canvas id="graficoAcertos"></canvas>
        </div>
        <div id="div_qualificacao"></div>

    </div>
    <script src="../script.js"></script>
    <script>
        let fkUsuario = sessionStorage.getItem("ID_USUARIO");
        async function carregarDashboard() {
            try {
                const response = await fetch(`http://localhost:3333/quiz/getDadosDashboard?fkUsuario=${fkUsuario}`, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json"
                    }
                });

                const data = await response.json();

                console.log("Dados do dashboard recebidos:", data);

                // Pegando valores da API
                let totalAcertos = Number(data[0].media_acertos) || 0;
                let totalErros = Number(data[0].media_erros) || 0;
                let totalTentativas = Number(data[0].total_quizzes) || 0;

                // Preenche os KPIs
                document.getElementById("kpi_acertos").innerHTML = totalAcertos;
                document.getElementById("kpi_erros").innerHTML = totalErros;
                document.getElementById("kpi_tentativas").innerHTML = totalTentativas;



            } catch (error) {
                console.error("Erro ao carregar dashboard:", error);
            }
        }
        async function carregarGraficoHistorico() {
            const response = await fetch(`http://localhost:3333/quiz/getHistoricoDashboard?fkUsuario=${fkUsuario}`);
            const data = await response.json();
            console.log("Dados do gráfico recebidos:", data);
            montarGraficoHistorico(data);
        }
        function montarGraficoHistorico(data) {

            let datas = data.map(item => item.data_hora);
            let acertos = data.map(item => Number(item.total_acertos));
            let erros = data.map(item => Number(item.total_erros));

            const ctx = document.getElementById("graficoAcertos");

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: datas,
                    datasets: [
                        {
                            label: "Acertos",
                            data: acertos,
                            backgroundColor: "#1E90FF",
                            borderColor: "#000",
                            borderWidth: 2
                        },
                        {
                            label: "Erros",
                            data: erros,
                            backgroundColor: "#FF1E1E",
                            borderColor: "#000",
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

    </script>
</body>

</html>